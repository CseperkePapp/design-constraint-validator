name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    name: Supply Chain Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Scan for Shai-Hulud IoCs
        run: |
          echo "=== Shai-Hulud Supply Chain Security Scan ==="
          FAILED=0

          # Check for malicious files
          echo "Checking for malicious files..."
          for pattern in "setup_bun.js" "bun_environment.js" "bun_setup.js"; do
            if find . -name "$pattern" -type f 2>/dev/null | grep -q .; then
              echo "FAIL: Found suspicious file matching '$pattern'"
              find . -name "$pattern" -type f
              FAILED=1
            fi
          done

          # Check for suspicious install scripts in package.json files
          echo "Checking package.json files for suspicious scripts..."
          for pkg in $(find . -name "package.json" -not -path "./node_modules/*" 2>/dev/null); do
            if grep -E '"(preinstall|postinstall)".*:.*"[^"]*curl[^"]*\|[^"]*bash' "$pkg" 2>/dev/null; then
              echo "FAIL: Suspicious curl|bash in install script: $pkg"
              FAILED=1
            fi
            if grep -E '"(preinstall|postinstall)".*:.*"[^"]*bun\.sh/install' "$pkg" 2>/dev/null; then
              echo "FAIL: Suspicious bun.sh install script: $pkg"
              FAILED=1
            fi
          done

          # Check for known malicious strings
          echo "Checking for known malicious signatures..."
          if grep -rIi "Sha..-Hulud.*Second.*Coming" --include="*.json" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v node_modules; then
            echo "FAIL: Found Shai-Hulud signature string"
            FAILED=1
          fi

          # Check for TruffleHog abuse patterns
          echo "Checking for credential exfiltration patterns..."
          if grep -rIiE "(trufflehog|gh.auth.token|npm.*token.*export|GITHUB_TOKEN.*>>)" --include="*.js" --include="*.ts" . 2>/dev/null | grep -v node_modules | grep -v ".github/workflows"; then
            echo "WARN: Potential credential access pattern found (review manually)"
          fi

          # Check for unexpected self-hosted runners in workflows
          echo "Checking for self-hosted runners..."
          if grep -r "runs-on:.*self-hosted" .github/workflows/ 2>/dev/null; then
            echo "WARN: Self-hosted runner detected (verify this is intentional)"
          fi

          # Check for unpinned actions (non-SHA references)
          echo "Checking for unpinned GitHub Actions..."
          if grep -rE "uses:.*@v[0-9]" .github/workflows/ 2>/dev/null | grep -v "#"; then
            echo "WARN: Found unpinned GitHub Actions (should use SHA)"
            grep -rE "uses:.*@v[0-9]" .github/workflows/ | grep -v "#"
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "SECURITY SCAN FAILED - Potential supply chain compromise detected!"
            echo "Review the findings above and investigate immediately."
            exit 1
          fi

          echo ""
          echo "Security scan passed - no IoCs detected"

  test:
    runs-on: ubuntu-latest
    needs: security-scan
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      - name: Validate example tokens (demo - expects violations)
        run: node cli/index.js validate --fail-on off

  sbom:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Use Node.js 20
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Generate SBOM
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

      - name: Validate SBOM
        run: |
          echo "SBOM generated successfully"
          cat sbom.json | jq '.metadata.component.name'
